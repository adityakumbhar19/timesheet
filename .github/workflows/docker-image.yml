name: Docker Image CI/CD with Integration Tests

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    services:
      # Start the MySQL container and explicitly map its port to the host
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: Neilsoft@100
          MYSQL_DATABASE: sample
        # ðŸ”‘ FIX: Map the MySQL port to the host machine
        ports:
          - 3307:3306 
        options: >-
          --name timesheet_mysql
          --health-cmd "mysqladmin ping -h localhost -pNeilsoft@100"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      # 1. Set up Node.js (Used for running 'npm install' and 'npm test' on the host)
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # 2. Build the backend image for testing
      - name: Build Backend Service Image
        run: docker build ./server --file ./server/Dockerfile --tag backend-test:latest

      # 3. Start the Backend service linked to the Host network
      - name: Start Backend Service for Testing
        run: |
          docker run -d --rm \
            --name timesheet_backend \
            # ðŸ”‘ FIX: Use Host Network for communication with the exposed MySQL service
            --network host \
            # ðŸ”‘ FIX: Expose the backend port (this is what 'wait_for_response' needs)
            -p 3001:3001 \
            -e MYSQL_HOST=127.0.0.1 \
            -e MYSQL_PORT=3307 \
            -e MYSQL_USER=root \
            -e MYSQL_PASSWORD=Neilsoft@100 \
            -e MYSQL_DB=sample \
            backend-test:latest

      # 4. Wait for the database and backend to be fully ready
      - name: Wait for Backend Health Check
        uses: nev7n/wait_for_response@v1
        with:
          # This URL is now accessible because the backend is running on the host network (localhost:3001)
          url: http://localhost:3001/health 
          responseCode: 200
          timeout: 180
          interval: 5 # Recommended to increase the interval for stability

      # 5. Install backend dependencies and run tests
      - name: Run Backend Integration Tests
        run: |
          cd server
          npm install
          npm test # <--- Ensure this command is correct and works with the host env variables
        env:
          MYSQL_HOST: 127.0.0.1
          MYSQL_PORT: 3307 
          # ... other necessary environment variables for your tests

---

  # ----------------------------------------------------
  # 2. BACKEND BUILD & PUSH JOB
  # ----------------------------------------------------
  build-backend:
    runs-on: ubuntu-latest
    needs: test # CRITICAL: Only runs if the 'test' job succeeds
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Login, Metadata, Build & Push steps for the backend image (targeting GHCR)
      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Backend Docker
        id: meta_backend
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}/backend # Tag as /backend
          tags: |
            type=sha,format=true,prefix=backend-

      - name: Build and push Backend image
        uses: docker/build-push-action@v5
        with:
          context: ./server
          file: ./server/Dockerfile
          push: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }} # Only push on main branch push
          tags: ${{ steps.meta_backend.outputs.tags }}

---

  # ----------------------------------------------------
  # 3. FRONTEND BUILD & PUSH JOB
  # ----------------------------------------------------
  build-frontend:
    runs-on: ubuntu-latest
    needs: test # Only runs if the 'test' job succeeds

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Login, Metadata, Build & Push steps for the frontend image
      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Frontend Docker
        id: meta_frontend
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}/frontend # Tag as /frontend
          tags: |
            type=sha,format=true,prefix=frontend-

      - name: Build and push Frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./client
          file: ./client/Dockerfile # Assuming the client Dockerfile is in ./client/Dockerfile
          push: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
          tags: ${{ steps.meta_frontend.outputs.tags }}

name: Docker Image CI/CD with Integration Tests

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  test:
    runs-on: ubuntu-latest
    
    # ----------------------------------------------------
    # 1. SERVICES: Define the MySQL service required for the backend
    # ----------------------------------------------------
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: Neilsoft@100
          MYSQL_DATABASE: sample
        # FIX: Map the MySQL port to the host machine so the backend can access it via localhost:3307
        ports:
          - 3307:3306 
        options: >-
          --name timesheet_mysql
          --health-cmd "mysqladmin ping -h localhost -pNeilsoft@100"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # 2. Build the backend image for testing
      - name: Build Backend Service Image
        run: docker build ./server --file ./server/Dockerfile --tag backend-test:latest

      # 3. Start the Backend service linked to the Host network
      # FIX: Changed to a robust single-line command to avoid shell parsing errors.
      - name: Start Backend Service for Testing
        run: docker run -d --rm --name timesheet_backend --network host -p 3001:3001 -e MYSQL_HOST=127.0.0.1 -e MYSQL_PORT=3307 -e MYSQL_USER=root -e MYSQL_PASSWORD=Neilsoft@100 -e MYSQL_DB=sample backend-test:latest

      # 4. Wait for the database and backend to be fully ready
      # The wait is now possible because the backend is exposed on localhost:3001
      - name: Wait for Backend Health Check
        uses: nev7n/wait_for_response@v1
        with:
          url: http://localhost:3001/health 
          responseCode: 200
          timeout: 180
          interval: 5

      # 5. Install backend dependencies and run tests
      - name: Run Backend Integration Tests
        run: |
          cd server
          npm install
          npm test # REMINDER: Replace 'npm test' with your actual test command
        env:
          MYSQL_HOST: 127.0.0.1
          MYSQL_PORT: 3307 

---

  # ----------------------------------------------------
  # 2. BACKEND BUILD & PUSH JOB
  # ----------------------------------------------------
  build-backend:
    runs-on: ubuntu-latest
    needs: test 
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Backend Docker
        id: meta_backend
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}/backend
          tags: |
            type=sha,format=true,prefix=backend-

      - name: Build and push Backend image
        uses: docker/build-push-action@v5
        with:
          context: ./server
          file: ./server/Dockerfile
          push: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
          tags: ${{ steps.meta_backend.outputs.tags }}

---

  # ----------------------------------------------------
  # 3. FRONTEND BUILD & PUSH JOB
  # ----------------------------------------------------
  build-frontend:
    runs-on: ubuntu-latest
    needs: test 

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Frontend Docker
        id: meta_frontend
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}/frontend
          tags: |
            type=sha,format=true,prefix=frontend-

      - name: Build and push Frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./client
          file: ./client/Dockerfile
          push: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
          tags: ${{ steps.meta_frontend.outputs.tags }}

name: Docker Image CI/CD with Integration Tests

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:

  # ----------------------------------------------------
  # 1. TEST JOB: Runs integration tests using docker-compose services
  # ----------------------------------------------------
  test:
    runs-on: ubuntu-latest
    
    # Define services using the provided docker-compose file.
    # We only start the MySQL and Backend services for testing.
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: Neilsoft@100
          MYSQL_DATABASE: sample
        # We don't expose ports here; the backend will communicate via the service name 'mysql'.
        options: >-
          --name timesheet_mysql
          --health-cmd "mysqladmin ping -h localhost -pNeilsoft@100"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      # 1. Set up Node.js for installing dependencies and running the test script
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      # 2. Build the backend image (this is required before running the test command)
      - name: Build Backend Service Image
        run: docker build ./server --file ./server/Dockerfile --tag backend-test:latest

      # 3. Start the Backend service linked to the MySQL service
      - name: Start Backend Service for Testing
        run: |
          docker run -d --rm \
            --name timesheet_backend \
            --network host \
            -e MYSQL_HOST=127.0.0.1 \
            -e MYSQL_USER=root \
            -e MYSQL_PASSWORD=Neilsoft@100 \
            -e MYSQL_DB=sample \
            backend-test:latest

      # 4. Wait for the database and backend to be fully ready
      - name: Wait for services to be healthy
        uses: nev7n/wait_for_response@v1
        with:
          url: http://localhost:3001/health # Use the backend's exposed port and health check route
          responseCode: 200
          timeout: 180

      # 5. Install backend dependencies and run tests
      # NOTE: This assumes your test runner is in the server directory (e.g., /server/package.json)
      - name: Run Backend Integration Tests
        run: |
          cd server
          npm install
          npm test # <--- REPLACE 'npm test' with your actual test command
        # Environment variables for the tests might need to match the container setup
        env:
          MYSQL_HOST: 127.0.0.1
          MYSQL_PORT: 3307 # Use the host port mapped in docker-compose, if testing directly.

---

  # ----------------------------------------------------
  # 2. BACKEND BUILD & PUSH JOB
  # ----------------------------------------------------
  build-backend:
    runs-on: ubuntu-latest
    needs: test # CRITICAL: Only runs if the 'test' job succeeds
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Login, Metadata, Build & Push steps for the backend image (targeting GHCR)
      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Backend Docker
        id: meta_backend
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}/backend # Tag as /backend
          tags: |
            type=sha,format=true,prefix=backend-

      - name: Build and push Backend image
        uses: docker/build-push-action@v5
        with:
          context: ./server
          file: ./server/Dockerfile
          push: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }} # Only push on main branch push
          tags: ${{ steps.meta_backend.outputs.tags }}

---

  # ----------------------------------------------------
  # 3. FRONTEND BUILD & PUSH JOB
  # ----------------------------------------------------
  build-frontend:
    runs-on: ubuntu-latest
    needs: test # Only runs if the 'test' job succeeds

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Login, Metadata, Build & Push steps for the frontend image
      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Frontend Docker
        id: meta_frontend
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository }}/frontend # Tag as /frontend
          tags: |
            type=sha,format=true,prefix=frontend-

      - name: Build and push Frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./client
          file: ./client/Dockerfile # Assuming the client Dockerfile is in ./client/Dockerfile
          push: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
          tags: ${{ steps.meta_frontend.outputs.tags }}
